machine:
    xcode:
        version: 8.3.3
dependencies:
    pre:
        - sudo mkdir -p /opt
        - sed -i~ -e '/^# Homebrew alternate path/ {N;N;d;}' ~/.bashrc
        - sed -i~ -e '/^# Homebrew alternate path/ {N;N;d;}' ~/.bash_profile
        - sed -i~ -e '/^# chruby hooks/ {N;N;N;d;}' ~/.bashrc
        - sed -i~ -e '/^# chruby hooks/ {N;N;N;d;}' ~/.bash_profile
        - sudo rm -rf /usr/local/*
        - sudo rm -rf /opt/*
        - curl -O http://download.arch-osx.org/snapshots/arch-osx-snapshot.tar.gz
        - sudo tar -C / -xvpzf arch-osx-snapshot.tar.gz
        - echo 'export PATH="/opt/arch/bin:/opt/arch/sbin:$PATH"' >> ~/.bashrc
        - echo 'export PATH="/opt/arch/bin:/opt/arch/sbin:$PATH"' >> ~/.bash_profile
        - sudo sed -i~ -e 's/^#Server/Server/' /opt/arch/etc/pacman.d/mirrorlist
    override:
        - sudo pacman --sync --refresh --noprogressbar
        - sudo pacman --sync --sysupgrade --noprogressbar --noconfirm --downloadonly
        - sudo pacman --sync --sysupgrade --noprogressbar --noconfirm
        - sudo pacman --sync --noprogressbar --noconfirm base-devel parallel
database:
    # trusted pgp keyring for source check
    override:
        - /usr/bin/true
compile:
    pre:
        - mkdir -p "$CIRCLE_ARTIFACTS"/{packages,srcpackages,makepkglogs}
        - sudo sed -i~ -e "s,^#PKGDEST=.*,PKGDEST=\"$CIRCLE_ARTIFACTS/packages\"," /opt/arch/etc/makepkg.conf
        - sudo sed -i~ -e "s,^#SRCPKGDEST=.*,SRCPKGDEST=\"$CIRCLE_ARTIFACTS/srcpackages\"," /opt/arch/etc/makepkg.conf
        - sudo sed -i~ -e "s,^#LOGDEST=.*,LOGDEST=\"$CIRCLE_ARTIFACTS/makepkglogs\"," /opt/arch/etc/makepkg.conf
        # sudo sed -i~ -e "s,^#PACKAGER=.*,PACKAGER=\"CircleCI\"", /opt/arch/etc/makepkg.conf
        # sudo sed -i~ -e "s,^#GPGKEY=.*,GPGKEY=\"\"", /opt/arch/etc/makepkg.conf
    override:
        - .support/build $(.support/changes master "${CIRCLE_SHA1}")
test:
    # clean /opt/arch, install base snapshot, install packages
    override:
        - /usr/bin/true
deployment:
    package:
        branch: master
        owner: arch-osx
        commands:
            - .support/push package "${CIRCLE_ARTIFACTS}"
    snapshot:
        tag: /snapshot-.*/
        owner: arch-osx
        commands:
            - .support/snapshot "${CIRCLE_REF}" "${CIRCLE_ARTIFACTS}"
            - .support/push snapshot "${CIRCLE_ARTIFACTS}"
