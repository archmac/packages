pkgname=docker-compose
pkgver=1.23.2
pkgrel=1
pkgdesc="Fast, isolated development environments using Docker"
arch=('any')
url="https://www.docker.com/"
license=("Apache")
depends=('python3')
source=("$pkgname-$pkgver.tar.gz::https://github.com/docker/compose/archive/$pkgver.tar.gz")
sha512sums=('baa233c84ac770798ba3d8d256687630b331d774a8d60f3c0d5046aa0a74c8c3b8b0b8bc4431f3bc7d5b7a54f0646f5e2fd14d5af31db37cb546e86c96c8c1db')

prepare() {
  cd compose-$pkgver

  # Remove upper bound on requires
  sed -i -e 's/==/>=/g' requirements.txt
  sed -i -e "s/, < .*',$/',/" setup.py
}

build() {
  cd compose-$pkgver

  venv="venv"

  python3 -m venv "$venv"
  "$venv"/bin/pip3 install -v --no-binary :all: --ignore-installed .
  "$venv"/bin/pip3 uninstall -y docker-compose

  "$venv"/bin/python3 setup.py build
}

check() {
  # Hack entry points by installing it
  # TODO: need a running docker daemon to test

  cd compose-$pkgver
  # python setup.py install --root="$PWD/tmp_install" --optimize=1
  # PATH="$PWD/tmp_install/usr/bin:$PATH" PYTHONPATH="$PWD/tmp_install/usr/lib/python3.7/site-packages:$PYTHONPATH" python setup.py pytest
}

package() {
  cd compose-$pkgver

  venv="$pkgdir/opt/arch/libexec/$pkgname/venv"

  python3 -m venv "$venv"
  "$venv"/bin/pip3 install -v --no-binary :all: --ignore-installed .
  "$venv"/bin/pip3 uninstall -y docker-compose
  "$venv"/bin/python3 setup.py install --optimize=1 --skip-build

  perl -pi -e "s!${pkgdir}!!" "$venv"/bin/*

  install -d -m755 "$pkgdir"/opt/arch/bin
  for bin in docker-compose; do
    ln -sf "/opt/arch/libexec/$pkgname/venv/bin/$bin" "$pkgdir"/opt/arch/bin/"$bin"
  done

  #install -Dm644 LICENSE "$pkgdir"/opt/arch/share/licenses/$pkgname/LICENSE
  #install -Dm644 contrib/completion/bash/docker-compose      "$pkgdir"/opt/arch/share/bash-completion/completions/docker-compose
  #install -Dm644 contrib/completion/fish/docker-compose.fish "$pkgdir"/opt/arch/share/fish/completions/docker-compose.fish
  #install -Dm644 contrib/completion/zsh/_docker-compose      "$pkgdir"/opt/arch/share/zsh/site-functions/_docker-compose
}
